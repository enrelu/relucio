---
import Parser from 'rss-parser';

const parser = new Parser();
const FEED_URL = 'https://ciberseguridadtactica.substack.com/feed';
let latestPost = null;
let error = null;

try {
  const feed = await parser.parseURL(FEED_URL);
  latestPost = feed.items[0];
} catch (e) {
  console.error("Error fetching Substack feed:", e);
  error = true;
}
---

{!error && latestPost && (
  <div id="newsletter-container">
    
    {/* 1. BOTÓN CIRCULAR (Solo móvil: Abajo a la derecha) */}
    <button 
      id="open-widget-mobile"
      class="xl:hidden fixed right-4 bottom-6 z-50 flex items-center justify-center w-12 h-12 rounded-full bg-orange-600 text-white shadow-lg border border-orange-500 transition-all duration-500 opacity-0 translate-y-10 pointer-events-none"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 7 13.03 12.7a1.94 1.94 0 0 1-2.06 0L2 7"/><rect width="20" height="16" x="2" y="4" rx="2"/></svg>
    </button>

    {/* 2. LA TARJETA (Móvil: Abajo / Escritorio: Centro) */}
    <aside 
      id="newsletter-widget"
      class="fixed z-50 flex flex-col gap-4 w-64 p-5 rounded-2xl bg-white/95 dark:bg-zinc-900/95 backdrop-blur-md border border-zinc-200 dark:border-zinc-800 shadow-2xl transition-all duration-500 ease-out opacity-0 pointer-events-none
             /* Móvil */
             right-4 bottom-6 translate-y-10
             /* Escritorio */
             xl:right-6 xl:top-1/2 xl:bottom-auto xl:-translate-y-1/2 xl:translate-x-[120%] xl:translate-y-[-50%]"
    >
      <button id="close-widget" class="absolute top-3 right-3 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>

      <div class="flex items-center gap-3">
          <div class="p-2 bg-orange-100 dark:bg-orange-900/30 rounded-lg text-orange-600 dark:text-orange-400 shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 7 13.03 12.7a1.94 1.94 0 0 1-2.06 0L2 7"/><rect width="20" height="16" x="2" y="4" rx="2"/></svg>
          </div>
          <h3 class="font-bold text-sm text-zinc-900 dark:text-zinc-100 leading-tight">Ciberseguridad Táctica</h3>
      </div>

      <div class="space-y-2">
        <p class="text-[10px] font-mono uppercase tracking-wider text-zinc-400">Newsletter: Última edición</p>
        <a href={latestPost.link} target="_blank" class="block font-medium text-sm text-zinc-800 dark:text-zinc-200 hover:text-orange-600 dark:hover:text-orange-400 transition-colors line-clamp-3">
          {latestPost.title}
        </a>
      </div>

      <a href="https://ciberseguridadtactica.substack.com/subscribe" target="_blank" class="mt-2 w-full flex justify-center items-center px-4 py-2 text-xs font-bold text-white bg-zinc-900 dark:bg-zinc-100 dark:text-zinc-900 rounded-lg hover:bg-orange-600 transition-all">
        Suscribirse
      </a>
    </aside>
  </div>
)}

<script>
  const widget = document.getElementById('newsletter-widget');
  const mobileBtn = document.getElementById('open-widget-mobile');
  const closeBtn = document.getElementById('close-widget');
  let isClosedByUser = false;

  const handleScroll = () => {
    if (!widget || !mobileBtn || isClosedByUser) return;
    
    const scrollPosition = window.scrollY;
    const isDesktop = window.innerWidth >= 1280;

    if (scrollPosition > 300) {
      if (isDesktop) {
        widget.classList.remove('opacity-0', 'xl:translate-x-[120%]', 'pointer-events-none');
        widget.classList.add('opacity-100', 'xl:translate-x-0', 'pointer-events-auto');
      } else {
        mobileBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
        mobileBtn.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
      }
    } else {
      // Ocultar al volver arriba
      widget.classList.add('opacity-0', 'pointer-events-none');
      widget.classList.remove('opacity-100', 'pointer-events-auto');
      mobileBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
      
      if (isDesktop) {
        widget.classList.add('xl:translate-x-[120%]');
        widget.classList.remove('xl:translate-x-0');
      } else {
        widget.classList.add('translate-y-10');
        widget.classList.remove('translate-y-0');
      }
    }
  };

  mobileBtn?.addEventListener('click', () => {
    widget?.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
    widget?.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
    mobileBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
  });

  closeBtn?.addEventListener('click', () => {
    const isDesktop = window.innerWidth >= 1280;
    if (isDesktop) {
      widget!.style.display = 'none';
      isClosedByUser = true;
    } else {
      widget?.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
      widget?.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
      mobileBtn?.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
    }
  });

  window.addEventListener('scroll', handleScroll, { passive: true });
</script>